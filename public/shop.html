<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Katalog UMKM AR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes slideUp { from { transform: translateY(100%) translateX(-50%); opacity: 0; } to { transform: translateY(0) translateX(-50%); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); }
    </style>
</head>

<body class="bg-slate-200 text-slate-800 pb-24 selection:bg-indigo-100 selection:text-indigo-600 min-h-screen flex justify-center">

    <div class="w-full max-w-md bg-gray-50 min-h-screen shadow-2xl relative overflow-hidden flex flex-col">
        
        <!-- HEADER -->
        <header class="relative overflow-hidden bg-white shadow-sm rounded-b-[2.5rem] pb-8 z-10">
            <div class="absolute top-0 left-0 w-full h-full overflow-hidden z-0">
                <div class="absolute -top-20 -left-20 w-64 h-64 bg-indigo-100 rounded-full blur-3xl opacity-60"></div>
                <div class="absolute top-10 -right-20 w-72 h-72 bg-purple-100 rounded-full blur-3xl opacity-60"></div>
            </div>
            <div class="relative z-10 px-6 pt-8">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <p class="text-xs font-bold text-indigo-600 tracking-wider uppercase mb-1">Welcome to</p>
                        <h1 class="text-3xl font-extrabold text-slate-900 leading-tight">BumDes<br><span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600">Kuala Alam</span></h1>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white shadow-lg shadow-indigo-200"><i data-lucide="store" class="w-5 h-5"></i></div>
                </div>
                <div class="flex gap-2 overflow-x-auto no-scrollbar pb-2">
                    <div class="glass px-3 py-1.5 rounded-full flex items-center gap-1.5 shadow-sm shrink-0"><i data-lucide="map-pin" class="w-3 h-3 text-rose-500"></i><span class="text-xs font-semibold text-slate-600">Bengkalis, Riau</span></div>
                    <a href="https://www.instagram.com/bumdesa_kuala_alam?" target="_blank" class="glass px-3 py-1.5 rounded-full flex items-center gap-1.5 shadow-sm active:scale-95 transition-transform shrink-0"><i data-lucide="instagram" class="w-3 h-3 text-pink-500"></i><span class="text-xs font-bold text-slate-600">@bumdeskualaalam</span></a>
                </div>
                <div class="mt-6 relative">
                    <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                    <input id="search-input" type="text" placeholder="Cari jajanan enak..." class="w-full bg-gray-50 border border-gray-100 rounded-2xl py-3.5 pl-12 pr-4 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-indigo-100 focus:border-indigo-200 transition-all shadow-inner placeholder-gray-400">
                </div>
            </div>
        </header>

        <!-- CATALOG -->
        <main class="px-5 mt-6 flex-1">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">ðŸ”¥ Katalog Produk</h2>
                <span class="text-xs font-medium text-gray-400 bg-gray-100 px-2 py-1 rounded-md">AR Ready</span>
            </div>

            <div id="loading" class="grid grid-cols-2 gap-4">
                <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 animate-pulse"><div class="bg-gray-200 h-32 w-full rounded-xl mb-3"></div><div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div><div class="h-3 bg-gray-200 rounded w-1/2"></div></div>
                <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 animate-pulse"><div class="bg-gray-200 h-32 w-full rounded-xl mb-3"></div><div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div><div class="h-3 bg-gray-200 rounded w-1/2"></div></div>
            </div>

            <div id="product-grid" class="grid grid-cols-2 gap-4 pb-10"></div>
            
            <div id="not-found" class="hidden flex-col items-center justify-center py-10 text-center">
                <div class="bg-gray-100 p-4 rounded-full mb-3"><i data-lucide="search-x" class="w-8 h-8 text-gray-400"></i></div>
                <p class="text-slate-500 font-medium">Yah, produknya gak ketemu.</p>
            </div>
        </main>
    </div>

    <!-- MODAL PILIHAN -->
    <div id="modal-overlay" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div class="absolute bottom-0 left-1/2 -translate-x-1/2 w-full max-w-md bg-white rounded-t-[2rem] p-6 shadow-[0_-10px_40px_rgba(0,0,0,0.1)] animate-slide-up">
            <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6"></div>
            <div class="flex items-center gap-4 mb-8">
                <div class="w-20 h-20 rounded-2xl bg-gray-50 border border-gray-100 p-1 shrink-0"><img id="modal-img" src="" class="w-full h-full object-cover rounded-xl shadow-sm"></div>
                <div><span class="text-xs font-bold text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded-md mb-1 inline-block">Pilihan Kamu</span><h3 id="modal-title" class="text-xl font-bold text-slate-800 leading-tight line-clamp-2">Nama Produk</h3></div>
            </div>
            <div class="space-y-3">
                <!-- Tombol AR: Default Hidden, Nanti dinyalain pake JS kalo support -->
                <button id="btn-ar-action" onclick="goToAR()" class="hidden w-full relative overflow-hidden bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-4 rounded-2xl flex items-center gap-4 shadow-lg shadow-indigo-200 active:scale-[0.98] transition-transform group">
                    <div class="bg-white/20 p-2 rounded-xl backdrop-blur-md"><i data-lucide="box" class="w-6 h-6 text-white"></i></div>
                    <div class="text-left flex-1"><span class="block font-bold text-lg">Lihat 3D / AR</span><span class="text-xs text-indigo-100">Scan pake kamera HP</span></div>
                    <i data-lucide="chevron-right" class="w-5 h-5 opacity-70 group-hover:translate-x-1 transition-transform"></i>
                </button>
                
                <!-- Pesan kalau AR gak support -->
                <div id="ar-unavailable-msg" class="hidden w-full bg-gray-100 text-gray-500 p-4 rounded-2xl text-center text-sm font-medium border border-gray-200">
                    ðŸš« Fitur AR belum tersedia untuk produk ini.
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <button onclick="goToVideo()" class="bg-white border border-gray-200 p-4 rounded-2xl flex flex-col items-center justify-center gap-2 text-slate-600 hover:bg-gray-50 hover:border-gray-300 active:scale-[0.98] transition-all shadow-sm">
                        <div class="bg-rose-100 p-2 rounded-full text-rose-500"><i data-lucide="play-circle" class="w-5 h-5"></i></div><span class="font-bold text-sm">Video</span>
                    </button>
                    <button onclick="goToDetail()" class="bg-white border border-gray-200 p-4 rounded-2xl flex flex-col items-center justify-center gap-2 text-slate-600 hover:bg-gray-50 hover:border-gray-300 active:scale-[0.98] transition-all shadow-sm">
                        <div class="bg-amber-100 p-2 rounded-full text-amber-600"><i data-lucide="info" class="w-5 h-5"></i></div><span class="font-bold text-sm">Detail</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- VIDEO PLAYER -->
    <div id="video-screen" class="fixed top-0 left-1/2 -translate-x-1/2 w-full max-w-md h-full z-[60] bg-black hidden flex-col justify-center animate-fade-in shadow-2xl">
        <button onclick="closeVideo()" class="absolute top-6 left-6 z-20 bg-white/10 backdrop-blur-md text-white p-3 rounded-full active:scale-90 transition"><i data-lucide="x" class="w-6 h-6"></i></button>
        <div class="w-full aspect-video bg-black relative"><video id="main-video" class="w-full h-full object-contain" controls playsinline></video></div>
        <div class="absolute bottom-10 left-0 w-full px-6 text-center"><h3 id="video-caption" class="text-white font-bold text-xl mb-1">Judul Video</h3><p class="text-gray-400 text-sm">Video Profil Produk</p></div>
    </div>

    <!-- DETAIL SCREEN -->
    <div id="detail-screen" class="fixed top-0 left-1/2 -translate-x-1/2 w-full max-w-md h-full z-[55] bg-white hidden shadow-2xl animate-fade-in">
        <div class="h-full w-full overflow-y-auto no-scrollbar relative">
            <div class="relative h-[40vh]">
                <img id="detail-img" src="" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                <button onclick="closeDetail()" class="absolute top-6 left-6 bg-white/20 backdrop-blur-md border border-white/30 text-white p-2.5 rounded-full shadow-lg active:scale-90 transition z-10"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
            </div>
            <div class="relative -mt-10 bg-white rounded-t-[2.5rem] p-8 min-h-[60vh] pb-40">
                <div class="w-12 h-1.5 bg-gray-100 rounded-full mx-auto mb-8"></div>
                <div class="flex justify-between items-start mb-6">
                    <h1 id="detail-title" class="text-3xl font-extrabold text-slate-900 w-2/3 leading-tight">Nama Produk</h1>
                    <div class="flex flex-col items-end"><span class="text-xs text-gray-400 font-bold uppercase mb-1">Harga</span><span id="detail-price" class="text-sm font-bold text-indigo-600 bg-indigo-50 px-3 py-1 rounded-lg">Rp 0</span></div>
                </div>
                <div class="space-y-8">
                    <div><h3 class="flex items-center gap-2 text-sm font-bold text-gray-900 uppercase tracking-wide mb-3"><i data-lucide="align-left" class="w-4 h-4 text-gray-400"></i> Deskripsi</h3><p id="detail-desc" class="text-gray-600 leading-relaxed text-sm">...</p></div>
                    <div><h3 class="flex items-center gap-2 text-sm font-bold text-gray-900 uppercase tracking-wide mb-3"><i data-lucide="flask-conical" class="w-4 h-4 text-gray-400"></i> Komposisi</h3><div id="detail-comp" class="bg-gray-50 border border-gray-100 rounded-xl p-4 text-sm text-gray-600 font-medium leading-relaxed">...</div></div>
                </div>
            </div>
        </div>
        
        <!-- Float CTA (Dynamic) -->
        <div id="detail-cta-container" class="absolute bottom-0 left-0 w-full p-4 bg-white/90 backdrop-blur-md border-t border-gray-100 z-20">
             <!-- Tombol AR di sini akan diupdate via JS -->
        </div>
    </div>

    <!-- JS LOGIC -->
    <script>
        lucide.createIcons();
        const API_URL = "https://api-ar-umkm-97qh.vercel.app/api/product";
        let productsData = [];
        let selectedProduct = null;

        // ðŸ”¥ GAK ADA LAGI ARRAY ID MANUAL! SEMUA OTOMATIS DARI DB ðŸ”¥

        async function fetchProducts() {
            try {
                const response = await fetch(API_URL, { headers: { "ngrok-skip-browser-warning": "true" } });
                const result = await response.json();
                if (result.status === 'success') {
                    productsData = result.data;
                    renderProducts(productsData);
                } else {
                    document.getElementById('loading').innerHTML = '<p class="text-center text-red-500 col-span-2">Gagal memuat data.</p>';
                }
            } catch (error) {
                console.error(error);
                document.getElementById('loading').innerHTML = '<p class="text-center text-red-500 col-span-2">Cek koneksi internet.</p>';
            }
        }

        document.getElementById('search-input').addEventListener('input', (e) => {
            const keyword = e.target.value.toLowerCase();
            const filteredData = productsData.filter(p => p.name.toLowerCase().includes(keyword));
            renderProducts(filteredData);
        });

        function renderProducts(products) {
            const grid = document.getElementById('product-grid');
            const notFound = document.getElementById('not-found');
            document.getElementById('loading').style.display = 'none';
            grid.innerHTML = '';

            if (products.length === 0) {
                notFound.classList.remove('hidden'); notFound.classList.add('flex');
            } else {
                notFound.classList.add('hidden'); notFound.classList.remove('flex');
            }

            products.forEach(p => {
                let imgUrl = p.image_url;
                if (imgUrl && imgUrl.includes('cloudinary')) imgUrl = imgUrl.replace('/upload/', '/upload/w_400,h_400,c_fill,q_auto/');
                
                // ðŸ”¥ LOGIC BARU: CEK DARI DATABASE (has_ar) ðŸ”¥
                const isAR = p.has_ar === true || p.has_ar === 1;

                const arBadge = isAR 
                    ? `<div class="absolute bottom-2 right-2 bg-white/90 backdrop-blur text-indigo-600 text-[10px] font-bold px-2 py-1 rounded-lg shadow-sm flex items-center gap-1"><i data-lucide="box" class="w-3 h-3"></i> AR</div>` 
                    : `<div class="absolute bottom-2 right-2 bg-gray-200/90 backdrop-blur text-gray-500 text-[10px] font-bold px-2 py-1 rounded-lg shadow-sm flex items-center gap-1"><i data-lucide="box-select" class="w-3 h-3"></i> No AR</div>`;

                const card = `
                    <div onclick="openModal(${p.id})" class="group bg-white rounded-3xl p-3 shadow-sm border border-gray-100 active:scale-95 transition-all duration-300 hover:shadow-md cursor-pointer animate-fade-in">
                        <div class="relative aspect-square rounded-2xl overflow-hidden mb-3 bg-gray-100">
                            <img src="${imgUrl}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" onerror="this.src='https://via.placeholder.com/150?text=No+Img'">
                            ${arBadge}
                        </div>
                        <div class="px-1">
                            <h3 class="font-bold text-slate-800 text-sm line-clamp-1 mb-1 group-hover:text-indigo-600 transition-colors">${p.name}</h3>
                            <p class="text-xs font-bold text-indigo-500 bg-indigo-50 inline-block px-2 py-1 rounded-md">Rp ${parseInt(p.price).toLocaleString('id-ID')}</p>
                        </div>
                    </div>
                `;
                grid.innerHTML += card;
            });
            lucide.createIcons();
        }

        function openModal(id) {
            selectedProduct = productsData.find(p => p.id === id);
            if (!selectedProduct) return;
            
            document.getElementById('modal-title').innerText = selectedProduct.name;
            let imgUrl = selectedProduct.image_url;
            if (imgUrl && imgUrl.includes('cloudinary')) imgUrl = imgUrl.replace('/upload/', '/upload/w_200,h_200,c_fill,q_auto/');
            document.getElementById('modal-img').src = imgUrl;

            // ðŸ”¥ LOGIC BARU: CEK DARI DATABASE (has_ar) ðŸ”¥
            const btnAR = document.getElementById('btn-ar-action');
            const msgAR = document.getElementById('ar-unavailable-msg');
            const isAR = selectedProduct.has_ar === true || selectedProduct.has_ar === 1;
            
            if (isAR) {
                btnAR.classList.remove('hidden'); btnAR.classList.add('flex');
                msgAR.classList.add('hidden');
            } else {
                btnAR.classList.add('hidden'); btnAR.classList.remove('flex');
                msgAR.classList.remove('hidden');
            }

            document.getElementById('modal-overlay').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('modal-overlay').classList.add('hidden'); }

        function goToVideo() {
            closeModal();
            const player = document.getElementById('video-screen');
            const video = document.getElementById('main-video');
            player.classList.remove('hidden'); player.classList.add('flex');
            video.src = selectedProduct.video_url;
            document.getElementById('video-caption').innerText = selectedProduct.name;
            video.play();
        }

        function closeVideo() {
            const video = document.getElementById('main-video');
            video.pause();
            const player = document.getElementById('video-screen');
            player.classList.add('hidden'); player.classList.remove('flex');
        }

        function goToDetail() {
            closeModal();
            document.getElementById('detail-title').innerText = selectedProduct.name;
            document.getElementById('detail-price').innerText = "Rp " + parseInt(selectedProduct.price).toLocaleString('id-ID');
            document.getElementById('detail-desc').innerText = selectedProduct.description || "Tidak ada deskripsi.";
            document.getElementById('detail-comp').innerText = selectedProduct.composition || "Data komposisi belum tersedia.";
            let imgUrl = selectedProduct.image_url;
            if (imgUrl && imgUrl.includes('cloudinary')) imgUrl = imgUrl.replace('/upload/', '/upload/w_800,q_auto/');
            document.getElementById('detail-img').src = imgUrl;

            // ðŸ”¥ LOGIC BARU: CEK DARI DATABASE (has_ar) ðŸ”¥
            const ctaContainer = document.getElementById('detail-cta-container');
            const isAR = selectedProduct.has_ar === true || selectedProduct.has_ar === 1;

            if (isAR) {
                ctaContainer.innerHTML = `
                    <button onclick="goToAR()" class="w-full bg-slate-900 text-white font-bold py-4 rounded-xl shadow-xl active:scale-[0.98] transition flex items-center justify-center gap-2">
                        <i data-lucide="box" class="w-5 h-5"></i> Lihat dalam AR
                    </button>`;
            } else {
                ctaContainer.innerHTML = `
                    <button disabled class="w-full bg-gray-200 text-gray-400 font-bold py-4 rounded-xl cursor-not-allowed flex items-center justify-center gap-2">
                        <i data-lucide="box-select" class="w-5 h-5"></i> AR Tidak Tersedia
                    </button>`;
            }
            lucide.createIcons(); 

            document.getElementById('detail-screen').classList.remove('hidden');
        }

        function closeDetail() { document.getElementById('detail-screen').classList.add('hidden'); }

        function goToAR() {
            if (!selectedProduct) return;
            // Clean URL (udah sesuai Vercel config)
            window.location.href = `/ar?id=${selectedProduct.id}`;
        }

        fetchProducts();
    </script>
</body>
</html>